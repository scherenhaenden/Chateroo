<div class="flex" [ngClass]="{'justify-end': message.sender === 'user', 'justify-start': message.sender === 'ai'}">
  <div class="max-w-2xl p-3 rounded-lg shadow-md" [ngClass]="{'bg-blue-500 text-white': message.sender === 'user', 'bg-white text-gray-800': message.sender === 'ai'}">
    <div *ngIf="!message.isLoading">
      <ng-container *ngFor="let segment of segments">
        <ng-container *ngIf="segment.type === 'code'; else textSeg">
          <app-copy-box
            [content]="segment.content"
            [language]="segment.language"
            (contentChange)="segment.content = $event"
          ></app-copy-box>
          <app-canvas *ngIf="isRenderable(segment.language)" [codeToRender]="segment.content"></app-canvas>
        </ng-container>
        <ng-template #textSeg>
          <div class="markdown-content" [innerHTML]="renderMarkdown(segment.content)"></div>
        </ng-template>
      </ng-container>

      <!-- Botones para Canvas y Live Code cuando están disponibles -->
      <div *ngIf="message.sender === 'ai' && (message.hasCanvas || message.hasLiveCode)" class="flex space-x-2 mt-3 pt-3 border-t border-gray-200">
        <button
          *ngIf="message.hasCanvas"
          (click)="openCanvas()"
          class="flex items-center space-x-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-xs hover:bg-blue-200 transition-colors">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <span>Ver en Canvas</span>
        </button>

        <button
          *ngIf="message.hasLiveCode"
          (click)="openLiveCode()"
          class="flex items-center space-x-1 px-3 py-1 bg-green-100 text-green-700 rounded-md text-xs hover:bg-green-200 transition-colors">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
          </svg>
          <span>Ejecutar Código</span>
        </button>
      </div>
    </div>
    <div *ngIf="message.isLoading" class="flex items-center space-x-2">
      <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
      <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.2s]"></div>
      <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.4s]"></div>
    </div>
  </div>
</div>
